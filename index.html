<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Dom√≥tica Pro&quot;,&quot;short_name&quot;:&quot;Dom√≥tica&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0A0E14&quot;,&quot;theme_color&quot;:&quot;#0A0E14&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAfGSURBVHja7d1tbttWGMfx03iA9gqpo1KrVI+1VqlWqlSpVqjW3X/s5ZgXkCAn97B5h/u+b0CSk5zP58i+/c73u74P/L3j9u3bbx+vBwCgdwD0BwB9AqA/AOgTQP8AoE8A/QGAOgH0BwC9An0B0CegPwDoE0B/ANAnAP0BgDoB9AegX4E+AdAnAP0BgD4B9AfgH6A/AOgTQP8AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTwD9AUCfgP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6G/gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Boolean(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGuess(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Boolean(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4EmAewG+AAAAAElFTkSuQmCC&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;192x192&quot;},{&quot;src&quot;:&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAfGSURBVHja7d1tbttWGMfx03iA9gqpo1KrVI+1VqlWqlSpVqjW3X/s5ZgXkCAn97B5h/u+b0CSk5zP58i+/c73u74P/L3j9u3bbx+vBwCgdwD0BwB9AqA/AOgTQP8AoE8A/QGgOgH0BwC9An0B0CegPwDoE0B/ANAnAP0BgDoB9AegX4E+AdAnAP0BgD4B9AfgH6A/AOgTQP8AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTwD9AUCfgP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6G/gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Boolean(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGuess(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6GE0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGGeolean(gb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4E0CcA/QGAOgH0B0CegP4AoE8A/QGAOgH0BwC9An0CoE8A/QGgTjD8B6Bfgb4EmAewG+AAAAAElFTkSuQmCC&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;sizes&quot;:&quot;512x512&quot;}]}" />
<title>Dom√≥tica Pro</title>

<style>
  :root{--bg:#0A0E14;--bg2:#0F1419;--card:#141920;--border:#1F2937;--text:#F9FAFB;--muted:#9CA3AF;--blue:#3B82F6;--blue2:#2563EB;--green:#10B981;--yellow:#F59E0B;--red:#EF4444}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .app{max-width:428px;margin:0 auto;min-height:100vh;background:var(--bg2)}
  .hdr{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--card),rgba(0,0,0,0));padding:16px 20px 12px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-weight:800;font-size:28px}
  .sub{margin:6px 0 0;color:var(--muted);font-size:13px}
  .content{padding:20px 20px 120px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px;margin-bottom:16px}
  .title{margin:0 0 12px;font-size:18px;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  .btn{padding:12px 16px;border:none;border-radius:12px;background:var(--blue);color:white;font-weight:700;cursor:pointer;user-select:none}
  .btn.out{background:transparent;border:1px solid var(--border);color:var(--muted)}
  .arc{border-radius:50px;padding:12px 18px;font-weight:800;text-transform:uppercase;box-shadow:inset 0 -4px 8px rgba(0,0,0,.35),0 8px 16px rgba(0,0,0,.4);color:#fff;border:none;cursor:pointer;user-select:none}
  .arc.green{background:linear-gradient(180deg,#10B981,#059669)}
  .arc.yellow{background:linear-gradient(180deg,#F59E0B,#D97706)}
  .arc.red{background:linear-gradient(180deg,#EF4444,#DC2626)}
  .arc.blue{background:linear-gradient(180deg,#3B82F6,#2563EB)}
  .arc.sm{padding:10px 14px;font-size:12px}
  .list{display:flex;flex-direction:column;gap:12px}
  .item{background:var(--bg);border:1px solid var(--border);border-radius:16px;padding:16px}
  .item h3{margin:0;font-size:15px}
  .meta{margin:4px 0 0;color:var(--muted);font-size:12px}
  .pills{display:flex;flex-wrap:wrap;gap:8px}
  .pill{padding:8px 12px;border:1px solid var(--border);border-radius:20px;background:var(--bg);color:var(--muted);font-weight:700;cursor:pointer;user-select:none}
  .pill.active{background:var(--blue);border-color:var(--blue);color:white}
  .form .lab{display:block;font-size:12px;color:var(--muted);margin:6px 0}
  .form .in,.form .sel{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text)}
  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  .hidden{display:none!important}
  .bottom{position:fixed;left:50%;transform:translateX(-50%);bottom:0;width:100%;max-width:428px;display:flex;gap:12px;justify-content:center;padding:16px;background:linear-gradient(0deg,var(--card),transparent);border-top:1px solid var(--border)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:var(--card);border:1px solid var(--border);padding:12px 14px;border-radius:12px;opacity:0;transition:.25s;pointer-events:none}
  .toast.show{opacity:1}
  .badge{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:6px 12px;border:1px solid var(--border);border-radius:18px;background:var(--card);color:var(--muted)}
  .switch{position:relative;width:46px;height:28px}
  .switch input{opacity:0;width:0;height:0}
  .switch span{position:absolute;inset:0;background:#222;border-radius:28px;transition:.25s}
  .switch span::before{content:"";position:absolute;width:22px;height:22px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.25s}
  .switch input:checked+span{background:#10B981}
  .switch input:checked+span::before{transform:translateX(18px)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .modal .box{background:var(--card);border:1px solid var(--border);padding:20px;border-radius:20px;width:90%;max-width:380px}

  .btn:active,.arc:active,.pill:active{transform:translateY(1px) scale(0.98);filter:brightness(0.95)}
  .pressed{transform:translateY(1px) scale(0.98);filter:brightness(0.95)}
</style>
</head>
<body>
<div class="app">
  <header class="hdr">
    <h1>Dom√≥tica Pro</h1>
    <p class="sub">Control inteligente del hogar</p>
    <div id="activeProfile" class="badge"></div>
  </header>

  <main id="v-home" class="content">
    <div class="card">
      <h2 class="title">Men√∫ Principal</h2>
      <div class="grid grid-2">
        <button class="btn" onclick="go('profiles')">‚öôÔ∏è<br>Settings IP</button>
        <button class="btn" onclick="go('lights')">üí°<br>Luces</button>
        <button class="btn" onclick="go('shutters')">ü™ü<br>Persianas</button>
        <button class="btn" onclick="go('calibration')">‚è±Ô∏è<br>Calibraci√≥n</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn out" onclick="exportLogs()">üóíÔ∏è Copiar logs</button>
      </div>
    </div>
  </main>

  <section id="v-profiles" class="content hidden">
    <div class="card">
      <h2 class="title">Perfiles IP</h2>
      <div id="profilesList" class="list"></div>
      <div style="margin-top:10px" class="grid grid-2">
        <button class="btn" onclick="openProfileForm()">Crear</button>
        <button class="btn out" onclick="go('home')">‚Üê Volver</button>
      </div>
    </div>

    <div id="profileForm" class="card hidden form">
      <h3 class="title" id="pfTitle">Nuevo perfil</h3>
      <label class="lab">Nombre</label>
      <input id="pfName" class="in" placeholder="Desde casa"/>
      <label class="lab">Host/IP o DNS (sin http://)</label>
      <input id="pfHost" class="in" placeholder="192.168.20.10"/>
      <div class="grid grid-2" style="margin-top:12px">
        <button class="btn" onclick="saveProfile()">Guardar</button>
        <button class="btn out" onclick="closeProfileForm()">Cancelar</button>
      </div>
    </div>
  </section>

  <section id="v-shutters" class="content hidden">
    <div class="card">
      <h2 class="title">Toda la casa</h2>
      <div class="grid grid-3">
        <button class="arc green" onclick="shuttersAll('UP')">Abrir</button>
        <button class="arc yellow" onclick="shuttersAll('STOP')">Parar</button>
        <button class="arc red" onclick="shuttersAll('DOWN')">Cerrar</button>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Por plantas</h2>
      <div id="floorPills" class="pills"></div>
      <div id="floorList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="title">Por fachadas</h2>
      <div id="facadePills" class="pills"></div>
      <div id="facadeList" class="list"></div>
    </div>

    <div class="card">
      <h2 class="title">Control individual</h2>
      <div id="shuttersList" class="list"></div>
    </div>

    <div class="card">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Programaci√≥n (Nube)</span>
        <button class="btn" onclick="openScheduleForm('shutters')">Crear</button>
      </div>
      <div id="schedShutters" class="list"></div>
    </div>

    <div class="bottom"><button class="arc red" onclick="go('home')">‚Üê Volver</button><button class="btn" onclick="go('profiles')">Settings</button></div>
  </section>

  <section id="v-lights" class="content hidden">
    <div class="card">
      <h2 class="title">Fachada principal</h2>
      <div class="grid grid-2">
        <button class="arc green" onclick="lightsAll(1)">Encender</button>
        <button class="arc red" onclick="lightsAll(0)">Apagar</button>
      </div>
    </div>

    <div class="card">
      <h2 class="title">Control individual</h2>
      <div id="lightsList" class="list"></div>
    </div>

    <div class="card">
      <div class="title" style="display:flex;justify-content:space-between;align-items:center">
        <span>Programaci√≥n (Nube)</span>
        <button class="btn" onclick="openScheduleForm('lights')">Crear</button>
      </div>
      <div id="schedLights" class="list"></div>
    </div>

    <div class="bottom"><button class="arc red" onclick="go('home')">‚Üê Volver</button><button class="btn" onclick="go('profiles')">Settings</button></div>
  </section>

  <section id="v-calibration" class="content hidden">
    <div class="card">
      <h2 class="title">Calibraci√≥n de Persianas</h2>
      <p class="sub">Configura el tiempo de bajada para control por porcentaje. Se guarda en la Nube.</p>
      <div id="calList" class="list"></div>
    </div>
    <div class="bottom"><button class="arc red" onclick="go('home')">‚Üê Volver</button></div>
  </section>

  <section id="v-calib-detail" class="content hidden">
    <div class="card">
      <h2 class="title" id="calibTitle">Calibraci√≥n</h2>
      <p class="sub" id="calibMeta"></p>
      <div class="card" style="background:transparent;border-color:var(--border);margin:8px 0">
        <b>Proceso de calibraci√≥n</b>
        <ol style="margin:8px 0 0 18px;color:var(--muted);font-size:13px;line-height:1.6">
          <li>Aseg√∫rate manually de que la persiana est√° <b>subida al 100%</b>.</li>
          <li>Pulsa <b>Iniciar Cron√≥metro</b> para comenzar la bajada.</li>
          <li>Cuando llegue al final, pulsa <b>Guardar Tiempo</b>.</li>
        </ol>
      </div>
      <div id="calTimerWrap" class="hidden"><div id="calTimer" style="font:700 36px/1 monospace;color:#F59E0B;text-align:center">00.0s</div></div>
      <div id="calCur" class="hidden" style="text-align:center;margin:10px 0;color:#10B981">Tiempo actual: <b id="calCurVal">--</b></div>
      <div class="grid" style="gap:10px">
        <button class="arc yellow" id="calStart" onclick="calStart()">Iniciar Cron√≥metro</button>
        <button class="arc blue" id="calSave" onclick="calSave()" disabled>Guardar Tiempo</button>
      </div>
    </div>
    <div class="bottom"><button class="arc red" onclick="go('calibration')">‚Üê Volver</button></div>
  </section>

  <div id="percentModal" class="modal">
    <div class="box">
      <h3 id="pmTitle" class="title">Control por Porcentaje</h3>
      <p class="sub" id="pmMeta"></p>
      <div style="font-size:40px;font-weight:800;color:#3B82F6;text-align:center" id="pmVal">50%</div>
      <input id="pmSlider" type="range" min="0" max="100" value="50" style="width:100%;margin:14px 0"/>
      <div class="grid grid-2">
        <button class="arc blue" onclick="executePercentage()">Ejecutar</button>
        <button class="btn out" onclick="closePercent()">Cancelar</button>
      </div>
    </div>
  </div>

  <section id="v-sched-form" class="content hidden">
    <div class="card form">
      <h2 class="title" id="sfTitle">Nueva programaci√≥n</h2>
      <p class="sub" id="sfScope"></p>

      <label class="lab">Nombre del perfil</label>
      <input id="sfName" class="in" placeholder="Ej. Verano, Invierno"/>

      <label class="lab">Destino</label>
      <select id="sfTargetType" class="sel">
        <option value="INDIVIDUAL">Selecci√≥n individual</option>
        <option value="ALL">Toda la casa</option>
        <option value="FLOOR">Por planta</option>
        <option value="FACADE">Por fachada</option>
      </select>
      <div id="sfTargetWrap" class="pills" style="margin-top:8px"></div>

      <label class="lab">Acci√≥n</label>
      <div id="sfActionWrap" class="grid grid-3"></div>

      <label class="lab">Tipo de disparo</label>
      <select id="sfTrigType" class="sel">
        <option value="time">Hora fija</option>
        <option value="solar">Amanecer/Anochecer</option>
      </select>

      <div id="sfTrigTime" class="row" style="margin-top:8px">
        <div>
          <label class="lab">Hora (HH:MM)</label>
          <input id="sfTime" class="in" type="time" step="60" value="08:00"/>
        </div>
        <div>
          <label class="lab">Zona (Europa/Madrid)</label>
          <input class="in" value="Autom√°tica (Nube)" disabled/>
        </div>
      </div>

      <div id="sfTrigSolar" class="hidden">
        <div class="row" style="margin-top:8px">
          <div>
            <label class="lab">Evento</label>
            <select id="sfSolarEvent" class="sel">
              <option value="sunrise">Amanecer</option>
              <option value="sunset">Anochecer</option>
            </select>
          </div>
          <div>
            <label class="lab">Signo del ajuste</label>
            <select id="sfSolarSign" class="sel">
              <option value="+">+</option>
              <option value="-">-</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label class="lab">Horas</label>
            <input id="sfSolarH" class="in" type="number" min="0" max="12" value="0"/>
          </div>
          <div>
            <label class="lab">Minutos</label>
            <input id="sfSolarM" class="in" type="number" min="0" max="59" value="0"/>
          </div>
        </div>
      </div>

      <div id="sfPctWrap" class="hidden" style="margin-top:8px">
        <label class="lab">Porcentaje de APERTURA (0=Cerrada, 100=Abierta)</label>
        <input id="sfPercent" class="in" type="number" min="0" max="100" value="50"/>
      </div>

      <label class="lab" style="margin-top:8px">D√≠as de la semana</label>
      <div id="sfDays" class="pills"></div>

      <div class="grid grid-2" style="margin-top:12px">
        <button class="btn" onclick="saveSchedule()">Guardar</button>
        <button class="btn out" onclick="cancelSchedule()">Cancelar</button>
      </div>
    </div>
  </section>

  <div id="toast" class="toast"></div>
</div>

<iframe id="cmd" style="display:none"></iframe>

<script>
// =================================================================
//                 MODIFICACI√ìN: CONEXI√ìN A LA NUBE
// =================================================================
const API_URL = "https://domotica-backend-3q5i.vercel.app";
// =================================================================

/*** === Estado base === ***/
const PORTS={1:8282,2:8181};
const SHUTTERS=[
  {id:'sot_cald',name:'Cuarto caldera',floor:'S√≥tano',facade:'Principal',board:1,r1:1,r2:2},
  {id:'pb_desp',name:'Despacho',floor:'Baja',facade:'Principal',board:1,r1:3,r2:4},
  {id:'pb_salon',name:'Sal√≥n',floor:'Baja',facade:'Trasera',board:1,r1:5,r2:6},
  {id:'pb_cocina',name:'Cocina',floor:'Baja',facade:'Trasera',board:1,r1:7,r2:8},
  {id:'pb_escal',name:'Escalera planta baja',floor:'Baja',facade:'Principal',board:1,r1:9,r2:10},
  {id:'p1_esca',name:'Escalera planta primera',floor:'Primera',facade:'Principal',board:1,r1:11,r2:12},
  {id:'p1_pablo',name:'Habitaci√≥n Pablo',floor:'Primera',facade:'Principal',board:1,r1:13,r2:14},
  {id:'p1_bano',name:'Ba√±o hab. principal',floor:'Primera',facade:'Principal',board:1,r1:15,r2:16},
  {id:'p1_prin',name:'Habitaci√≥n principal',floor:'Primera',facade:'Trasera',board:2,r1:1,r2:2},
  {id:'p1_alex',name:'Habitaci√≥n Alex',floor:'Primera',facade:'Trasera',board:2,r1:3,r2:4},
  {id:'buh_1',name:'Buhardilla 1',floor:'Buhardilla',facade:'Principal',board:2,r1:5,r2:6},
  {id:'buh_2',name:'Buhardilla 2',floor:'Buhardilla',facade:'Principal',board:2,r1:12,r2:13},
  {id:'buh_es',name:'Escalera buhardilla',floor:'Buhardilla',facade:'Principal',board:2,r1:15,r2:16},
];
const LIGHTS=[
  {id:'l_desp',name:'Luz Despacho',board:2,relay:7},
  {id:'l_es_p1',name:'Luz Escalera Planta 1',board:2,relay:8},
  {id:'l_pablo',name:'Luz Habitaci√≥n Pablo',board:2,relay:9},
  {id:'l_es_buh',name:'Luz Escalera Buhardilla',board:2,relay:10},
  {id:'l_buh',name:'Luz Buhardilla',board:2,relay:11},
];

// Perfiles y calibraciones A√öN se guardan en localStorage para uso local
let profiles=JSON.parse(localStorage.getItem('domo_profiles')||'[]');
let activeProfileId=localStorage.getItem('domo_activeProfileId')||null;
let shutterCalibrations=JSON.parse(localStorage.getItem('domo_shutterCalibrations')||'{}');

// Programaciones AHORA se cargan desde la API
let schedulesLights=[];
let schedulesShutters=[];

let currentCalib=null, calTimer=null, calT0=0;

/*** === LOGS === ***/
let logs = JSON.parse(localStorage.getItem('domo_logs')||'[]');
function log(msg){
  const line = `[${new Date().toISOString()}] ${msg}`;
  logs.push(line);
  if(logs.length>5000) logs = logs.slice(-2000);
  localStorage.setItem('domo_logs', JSON.stringify(logs));
}

/*** === Utilidades UI === ***/
function toast(m,ms=2200){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),ms)}
function go(id){
  document.querySelectorAll('.content').forEach(v=>v.classList.add('hidden'));
  document.getElementById('v-'+id).classList.remove('hidden');
  window.scrollTo(0,0);
  if(id==='profiles') renderProfiles();
  // MODIFICACI√ìN: renderSchedLists() ahora es async y se llama desde go()
  if(id==='shutters'){renderShutters();renderSchedLists();}
  if(id==='lights'){renderLights();renderSchedLists();}
  if(id==='calibration') renderCalList();
  renderBadge();
  log(`Navegaci√≥n ‚Üí ${id}`);
}
function renderBadge(){const p=profiles.find(x=>x.id===activeProfileId);document.getElementById('activeProfile').textContent=p?`‚óè ${p.name} ‚Üí ${p.host}`:'Sin perfil'}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

/*** === Red / Env√≠os === ***/
// Delay robusto para los rel√©s
const SEND_DELAY_MS = 750;

function getHost(){
  const p=profiles.find(x=>x.id===activeProfileId);
  if(!p){toast('Selecciona un perfil IP en Settings');throw'no profile'}
  return p.host
}
function urlFor({board,relay,value}){return `http://${getHost()}:${PORTS[board]}/pwr/relays/${relay}?ac=12356&value=${value}`}

// Env√≠o de comandos LOCAL (para control manual)
function sendRelay(board,relay,value, massive=false){
  const url=urlFor({board,relay,value});
  log(`HTTP GET ${url}`);
  const iframe=document.getElementById('cmd');
  iframe.src=url;  
  return new Promise(res=>setTimeout(res, SEND_DELAY_MS));
}

// =================================================================
//           C√ìDIGO A√ëADIDO: GESTI√ìN DE PERFILES IP
// =================================================================
let currentProfile = null; // Para editar

function renderProfiles() {
  const list = document.getElementById('profilesList');
  list.innerHTML = ''; // Limpiar lista
  profiles = JSON.parse(localStorage.getItem('domo_profiles') || '[]');
  activeProfileId = localStorage.getItem('domo_activeProfileId') || null;

  if (profiles.length === 0) {
    list.innerHTML = '<p class="sub" style="text-align:center; margin:16px 0;">No hay perfiles. Pulsa "Crear" para a√±adir uno.</p>';
  }

  profiles.forEach(p => {
    const d = document.createElement('div');
    d.className = 'item';
    const isActive = p.id === activeProfileId;
    d.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>${p.name} <span style="color:${isActive ? 'var(--green)' : 'var(--muted)'}">${isActive ? '(Activo)' : ''}</span></h3>
          <div class="meta">${p.host}</div>
        </div>
      </div>
      <div class="pills" style="margin-top:12px; justify-content:flex-end;">
        ${!isActive ? `<button class="pill" onclick="setActiveProfile('${p.id}')">Activar</button>` : ''}
        <button class="pill" onclick="editProfile('${p.id}')">Editar</button>
        <button class="pill" onclick="deleteProfile('${p.id}')">Borrar</button>
      </div>
    `;
    list.appendChild(d);
  });
  renderBadge();
}

function openProfileForm(id = null) {
  const form = document.getElementById('profileForm');
  if (id) {
    // Editando
    currentProfile = profiles.find(p => p.id === id);
    if (!currentProfile) return;
    document.getElementById('pfTitle').textContent = 'Editar perfil';
    document.getElementById('pfName').value = currentProfile.name;
    document.getElementById('pfHost').value = currentProfile.host;
  } else {
    // Creando
    currentProfile = null;
    document.getElementById('pfTitle').textContent = 'Nuevo perfil';
    document.getElementById('pfName').value = '';
    document.getElementById('pfHost').value = '';
  }
  form.classList.remove('hidden');
}

function closeProfileForm() {
  document.getElementById('profileForm').classList.add('hidden');
  currentProfile = null;
}

function saveProfile() {
  const name = document.getElementById('pfName').value.trim();
  const host = document.getElementById('pfHost').value.trim();

  if (!name || !host) {
    toast('Debes rellenar el nombre y el host/IP.');
    return;
  }

  if (currentProfile) {
    // Editando
    currentProfile.name = name;
    currentProfile.host = host;
  } else {
    // Creando
    const newProfile = {
      id: String(Date.now()),
      name: name,
      host: host
    };
    profiles.push(newProfile);
    // Si es el primer perfil, activarlo
    if (profiles.length === 1) {
      setActiveProfile(newProfile.id);
    }
  }
  
  localStorage.setItem('domo_profiles', JSON.stringify(profiles));
  log(`Perfil ${currentProfile ? 'editado' : 'creado'}: ${name}`);
  closeProfileForm();
  renderProfiles();
}

function deleteProfile(id) {
  if (!confirm('¬øSeguro que quieres borrar este perfil?')) return;
  
  profiles = profiles.filter(p => p.id !== id);
  localStorage.setItem('domo_profiles', JSON.stringify(profiles));
  
  if (activeProfileId === id) {
    activeProfileId = null;
    localStorage.removeItem('domo_activeProfileId');
  }
  
  log(`Perfil borrado: ${id}`);
  renderProfiles();
}

function setActiveProfile(id) {
  activeProfileId = id;
  localStorage.setItem('domo_activeProfileId', id);
  log(`Perfil activado: ${id}`);
  renderProfiles();
}

// Necesito la funci√≥n editProfile que llama a openProfileForm
function editProfile(id) {
  openProfileForm(id);
}
// =================================================================
//           FIN DEL C√ìDIGO A√ëADIDO
// =================================================================


/*** === Antirrebote + Lock post-STOP (solo grupos) === ***/
const DEBOUNCE_MS = 900;
const POST_STOP_LOCK_MS = 2500;
const lastGroupAction = new Map(); // key -> timestamp
const groupLocks = new Map();      // key -> until timestamp

function groupKeyAll(){ return 'ALL' }
function groupKeyFloor(name){ return `FLOOR:${name}` }
function groupKeyFacade(name){ return `FACADE:${name}` }

function canRunGroupAction(key, dir){
  const now=Date.now();
  const until = groupLocks.get(key)||0;
  if(dir!=='STOP' && until>now){
    log(`GroupAction BLOQUEADA por lock (${key})`);
    return false;
  }
  const last = lastGroupAction.get(key) || 0;
  if(dir!=='STOP' && (now-last)<DEBOUNCE_MS){
    log(`GroupAction IGNORADA por debounce (${key})`);
    return false;
  }
  lastGroupAction.set(key, now);
  return true;
}
function applyStopLock(key){
  const until=Date.now()+POST_STOP_LOCK_MS;
  groupLocks.set(key, until);
  log(`Group STOP lock aplicado ${key}`);
}

/*** === Persianas (Control Manual) === ***/
async function shutterAction(sh,dir,opts={}){
  if(!sh) return;
  const a=dir==='UP'?'Abrir':dir==='DOWN'?'Cerrar':'Parar';
  log(`ShutterAction: ${a} ‚Üí ${sh.name} [P${sh.board} R${sh.r1}+${sh.r2}]`);
  toast(`${a} ${sh.name}`);
  const massive = !!opts.massive;
  if(dir==='STOP'){
    await sendRelay(sh.board,sh.r1,0,massive);
    await sendRelay(sh.board,sh.r2,0,massive);
  }else{
    await sendRelay(sh.board,sh.r1,1,massive);
    await sendRelay(sh.board,sh.r2,(dir==='UP'?0:1),massive);
  }
}
function unique(a){return [...new Set(a)]}
async function floorAction(floor,dir){
  const key = groupKeyFloor(floor);
  if(!canRunGroupAction(key, dir)) return;
  log(`FloorAction: ${floor} ‚Üí ${dir}`);
  const items=SHUTTERS.filter(s=>s.floor===floor);
  for(const s of items){ await shutterAction(s,dir,{massive:true}) }
  if(dir==='STOP') applyStopLock(key);
}
async function facadeAction(facade,dir){
  const key = groupKeyFacade(facade);
  if(!canRunGroupAction(key, dir)) return;
  log(`FacadeAction: ${facade} ‚Üí ${dir}`);
  const items=SHUTTERS.filter(s=>s.facade===facade);
  for(const s of items){ await shutterAction(s,dir,{massive:true}) }
  if(dir==='STOP') applyStopLock(key);
}
async function shuttersAll(dir){
  const key = groupKeyAll();
  if(!canRunGroupAction(key, dir)) return;
  log(`AllShutters ‚Üí ${dir}`);
  for(const s of SHUTTERS){ await shutterAction(s,dir,{massive:true}) }
  if(dir==='STOP') applyStopLock(key);
}
function renderShutters(){
  const floors=unique(SHUTTERS.map(s=>s.floor)), fp=document.getElementById('floorPills'), fl=document.getElementById('floorList');fp.innerHTML='';fl.innerHTML='';
  floors.forEach(f=>{const b=document.createElement('button');b.className='pill';b.textContent=f;b.onclick=()=>{fp.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));b.classList.add('active');fl.innerHTML='';const count=SHUTTERS.filter(s=>s.floor===f).length;const d=document.createElement('div');d.className='item';d.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center"><div><h3>${f}</h3><div class="meta">${count} persianas</div></div></div>
    <div class="grid grid-3" style="margin-top:8px">
      <button class="arc green" onclick="floorAction('${f}','UP')">Abrir</button>
      <button class="arc yellow" onclick="floorAction('${f}','STOP')">Parar</button>
      <button class="arc red" onclick="floorAction('${f}','DOWN')">Cerrar</button>
    </div>`;fl.appendChild(d)};fp.appendChild(b)});
  const fac=unique(SHUTTERS.map(s=>s.facade)), ap=document.getElementById('facadePills'), al=document.getElementById('facadeList');ap.innerHTML='';al.innerHTML='';
  fac.forEach(f=>{const b=document.createElement('button');b.className='pill';b.textContent=f;b.onclick=()=>{ap.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));b.classList.add('active');al.innerHTML='';const count=SHUTTERS.filter(s=>s.facade===f).length;const d=document.createElement('div');d.className='item';d.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center"><div><h3>${f}</h3><div class="meta">${count} persianas</div></div></div>
    <div class="grid grid-3" style="margin-top:8px">
      <button class="arc green" onclick="facadeAction('${f}','UP')">Abrir</button>
      <button class="arc yellow" onclick="facadeAction('${f}','STOP')">Parar</button>
      <button class="arc red" onclick="facadeAction('${f}','DOWN')">Cerrar</button>
    </div>`;al.appendChild(d)};ap.appendChild(b)});
  const list=document.getElementById('shuttersList');list.innerHTML='';
  SHUTTERS.forEach(s=>{const calib=shutterCalibrations[s.id];const hasPct=!!(calib&&calib.downTime>0);const d=document.createElement('div');d.className='item';d.innerHTML=`
    <div><h3>${s.name}</h3><div class="meta">${s.floor} ‚Ä¢ ${s.facade} ‚Ä¢ P${s.board}(R${s.r1}+${s.r2})</div></div>
    <div class="grid ${hasPct?'grid-4':'grid-3'}" style="margin-top:8px">
      <button class="arc sm green" onclick="shutterAction(getSh('${s.id}'),'UP')">Abrir</button>
      ${hasPct?`<button class="arc sm blue" onclick="openPercent('${s.id}')">%</button>`:''}
      <button class="arc sm yellow" onclick="shutterAction(getSh('${s.id}'),'STOP')">Parar</button>
      <button class="arc sm red" onclick="shutterAction(getSh('${s.id}'),'DOWN')">Cerrar</button>
    </div>`;list.appendChild(d)})
}
function getSh(id){return SHUTTERS.find(x=>x.id===id)}

/*** === Luces (Control Manual) === ***/
function renderLights(){const list=document.getElementById('lightsList');list.innerHTML='';LIGHTS.forEach(l=>{const d=document.createElement('div');d.className='item';d.innerHTML=`
  <div><h3>${l.name}</h3><div class="meta">Placa ${l.board} ‚Ä¢ Rel√© ${l.relay}</div></div>
  <div class="grid grid-2" style="margin-top:8px">
    <button class="arc green" onclick="lightDo('${l.id}',1)">Encender</button>
    <button class="arc red" onclick="lightDo('${l.id}',0)">Apagar</button>
  </div>`;list.appendChild(d)})}
async function lightDo(id,val){const l=LIGHTS.find(x=>x.id===id);log(`Light ${l.name} ‚Üí ${val?'ON':'OFF'}`);toast(`${val?'Encender':'Apagar'} ${l.name}`);await sendRelay(l.board,l.relay,val)}
async function lightsAll(v){log(`AllLights ‚Üí ${v?'ON':'OFF'}`);for(const l of LIGHTS){await lightDo(l.id,v)}}

/*** === Calibraci√≥n (MODIFICADO) === ***/
async function saveCalibrationsToCloud() {
  log('Enviando calibraciones a la nube...');
  try {
    const res = await fetch(`${API_URL}/api/saveCalibrations`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(shutterCalibrations)
    });
    if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
    log('Calibraciones guardadas en la nube.');
  } catch (e) {
    console.error(e);
    toast('Error al guardar calibraci√≥n en nube');
  }
}
function renderCalList(){const list=document.getElementById('calList');list.innerHTML='';SHUTTERS.forEach(s=>{const c=shutterCalibrations[s.id];const t=c?` ‚è± ${(c.downTime/1000).toFixed(1)}s`:'';const d=document.createElement('div');d.className='item';d.innerHTML=`
  <div style="display:flex;justify-content:space-between;align-items:center"><div><h3>${s.name}</h3><div class="meta">${s.floor} ‚Ä¢ ${s.facade}${t}</div></div><button class="pill" onclick="openCal('${s.id}')">${c?'Recalibrar':'Calibrar'}</button></div>`;list.appendChild(d)})}
function openCal(id){currentCalib=getSh(id);document.getElementById('calibTitle').textContent='Calibraci√≥n: '+currentCalib.name;document.getElementById('calibMeta').textContent=`${currentCalib.floor} ‚Ä¢ ${currentCalib.facade}`;document.getElementById('calTimer').textContent='00.0s';document.getElementById('calTimerWrap').classList.add('hidden');const c=shutterCalibrations[id];const cur=document.getElementById('calCur');if(c){cur.classList.remove('hidden');document.getElementById('calCurVal').textContent=(c.downTime/1000).toFixed(1)+'s'}else{cur.classList.add('hidden')}document.getElementById('calStart').disabled=false;document.getElementById('calSave').disabled=true;go('calib-detail');log(`OpenCal ‚Üí ${id}`)}
async function calStart(){if(!currentCalib){toast('Selecciona una persiana');return}document.getElementById('calStart').disabled=true;document.getElementById('calSave').disabled=false;document.getElementById('calTimerWrap').classList.remove('hidden');calT0=Date.now();calTimer=setInterval(()=>{document.getElementById('calTimer').textContent=((Date.now()-calT0)/1000).toFixed(1)+'s'},100);log(`CalStart ‚Üì ${currentCalib.name}`);await shutterAction(currentCalib,'DOWN')}
async function calSave(){
  if(!currentCalib||!calT0){toast('Inicia el cron√≥metro');return}
  clearInterval(calTimer);
  await shutterAction(currentCalib,'STOP');
  const t=Date.now()-calT0;
  if(t<800){toast('Tiempo muy corto, repite');log('CalSave rechazado: tiempo < 0.8s');return}
  
  // Guardar localmente
  shutterCalibrations[currentCalib.id]={downTime:t,calibratedAt:new Date().toISOString()};
  localStorage.setItem('domo_shutterCalibrations',JSON.stringify(shutterCalibrations));
  log(`CalSave OK: ${currentCalib.name} = ${(t/1000).toFixed(1)}s`);
  toast('Calibraci√≥n guardada');
  
  // MODIFICACI√ìN: Enviar a la nube
  await saveCalibrationsToCloud();
  
  openCal(currentCalib.id);
}

/*** === Porcentaje (Control Manual) === ***/
let pctSh=null;
let percentRunning=false;
function openPercent(id){const sh=getSh(id);const c=shutterCalibrations[id];if(!c){toast('Primero calibra esta persiana');return}pctSh=sh;document.getElementById('pmTitle').textContent=sh.name;document.getElementById('pmMeta').textContent=`Tiempo total: ${(c.downTime/1000).toFixed(1)}s`;document.getElementById('pmSlider').value=50;document.getElementById('pmVal').textContent='50%';document.getElementById('percentModal').classList.add('show');log(`OpenPercent ‚Üí ${sh.name}`)}
function closePercent(){document.getElementById('percentModal').classList.remove('show')}
document.getElementById('pmSlider').addEventListener('input',e=>{document.getElementById('pmVal').textContent=e.target.value+'%'})
async function executePercentage(){
  if(percentRunning) return;
  percentRunning=true;
  try{
    const sh=pctSh; const slider=document.getElementById('pmSlider'); const p=parseInt(slider.value,10);
    if(!sh){toast('Error: persiana no reconocida');return}
    closePercent();
    const cal=shutterCalibrations[sh.id]; if(!cal){toast('Sin calibraci√≥n');return}
    log(`Percent START ‚Üí ${sh.name} ‚Üí ${p}% (downTime=${cal.downTime}ms)`);
    await shutterAction(sh,'UP'); await sleep(cal.downTime*1.25); await shutterAction(sh,'STOP'); await sleep(200);
    const downMs=Math.round(cal.downTime*(100-p)/100);
    if(downMs>0){await shutterAction(sh,'DOWN'); await sleep(downMs);}
    await shutterAction(sh,'STOP'); await sleep(250); await shutterAction(sh,'STOP');
    log(`Percent END ‚Üí ${sh.name} = ${p}%`);
    toast('Persiana al '+p+'%');
  } finally {
    pctSh=null;
    percentRunning=false;
  }
}

// =================================================================
//          MODIFICACI√ìN: SECCI√ìN DE PROGRAMACI√ìN (NUBE)
// =================================================================

async function saveSchedulesToCloud() {
  log('Guardando programaciones en la nube...');
  try {
    const res = await fetch(`${API_URL}/api/saveSchedules`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ lights: schedulesLights, shutters: schedulesShutters })
    });
    if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
    log('Programaciones guardadas en la nube.');
    return true;
  } catch(e) {
    console.error(e);
    toast('Error al guardar en la nube');
    return false;
  }
}

async function renderSchedLists(){
  log('Cargando programaciones desde la nube...');
  try {
    const res = await fetch(`${API_URL}/api/getSchedules`);
    if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
    const data = await res.json();
    schedulesLights = data.lights || [];
    schedulesShutters = data.shutters || [];
    log('Programaciones cargadas.');
  } catch (e) {
    console.error("Error cargando programaciones", e);
    toast("Error al cargar programaciones");
  }
  
  const SL=document.getElementById('schedLights'); SL.innerHTML='';
  (schedulesLights||[]).forEach(s=>SL.appendChild(schedCard(s,'lights')));
  const SS=document.getElementById('schedShutters'); SS.innerHTML='';
  (schedulesShutters||[]).forEach(s=>SS.appendChild(schedCard(s,'shutters')));
}

function schedCard(s,mode){
  const d=document.createElement('div'); d.className='item';
  const days=s.days.map(i=>['L','M','X','J','V','S','D'][i]).join(' ');
  const trig=s.trigger.type==='time'?`‚è∞ ${s.trigger.at}`:`‚òÄ ${s.trigger.event||'?'}${s.trigger.sign||'+'}${pad2(s.trigger.h||0)}:${pad2(s.trigger.m||0)}`;
  d.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3>${s.name}</h3><div class="meta">${trig} ¬∑ D√≠as: ${days}</div></div>
      <label class="switch"><input type="checkbox" ${s.enabled?'checked':''} onchange="schedToggle('${mode}','${s.id}')"><span></span></label>
    </div>
    <div class="pills" style="margin-top:8px">
      <button class="pill" onclick="editSchedule('${mode}','${s.id}')">Editar</button>
      <button class="pill" onclick="schedDel('${mode}','${s.id}')">Borrar</button>
    </div>`;
  return d;
}
function openScheduleForm(mode){
  document.getElementById('sfTitle').textContent='Nueva programaci√≥n - '+(mode==='lights'?'Luces':'Persianas');
  document.getElementById('sfScope').textContent=mode==='lights'?'Programa encendidos y apagados autom√°ticos':'Programa aperturas/cierres o porcentaje';
  document.getElementById('v-sched-form').dataset.mode=mode;
  document.getElementById('v-sched-form').dataset.edit='';
  document.getElementById('sfName').value='';
  document.getElementById('sfTargetType').value='INDIVIDUAL';
  buildTargets();
  buildActions();
  document.getElementById('sfTrigType').value='time'; showTrig();
  document.getElementById('sfTime').value='08:00';
  document.getElementById('sfSolarEvent').value='sunrise';document.getElementById('sfSolarSign').value='+';document.getElementById('sfSolarH').value='0';document.getElementById('sfSolarM').value='0';
  buildDays();
  go('sched-form');
}
function editSchedule(mode,id){
  const arr=mode==='lights'?schedulesLights:schedulesShutters; const s=arr.find(x=>x.id===id); if(!s) return;
  openScheduleForm(mode);
  document.getElementById('v-sched-form').dataset.edit=id;
  document.getElementById('sfName').value=s.name;
  document.getElementById('sfTargetType').value=s.target.type; buildTargets(s.target.ids||[]);
  buildActions(s.action, mode);
  document.getElementById('sfTrigType').value=s.trigger.type; showTrig();
  if(s.trigger.type==='time'){document.getElementById('sfTime').value=s.trigger.at}
  else{document.getElementById('sfSolarEvent').value=s.trigger.event;document.getElementById('sfSolarSign').value=s.trigger.sign;document.getElementById('sfSolarH').value=s.trigger.h;document.getElementById('sfSolarM').value=s.trigger.m}
  buildDays(s.days);
}
function buildTargets(preSel=[]){
  const type=document.getElementById('sfTargetType').value; const wrap=document.getElementById('sfTargetWrap'); wrap.innerHTML='';
  let items=[];
  if(type==='INDIVIDUAL') items=(document.getElementById('v-sched-form').dataset.mode==='lights'?LIGHTS:SHUTTERS).map(x=>({id:x.id,name:x.name}));
  if(type==='FLOOR') items=[...new Set(SHUTTERS.map(s=>s.floor))].map(x=>({id:x,name:x}));
  if(type==='FACADE') items=[...new Set(SHUTTERS.map(s=>s.facade))].map(x=>({id:x,name:x}));
  items.forEach(it=>{const b=document.createElement('button');b.className='pill';b.textContent=it.name;b.dataset.id=it.id;if(preSel.includes(it.id)) b.classList.add('active');b.onclick=()=>b.classList.toggle('active');wrap.appendChild(b)});
}
document.getElementById('sfTargetType').addEventListener('change',()=>buildTargets());
function buildActions(existing, mode){
  const w=document.getElementById('sfActionWrap'); w.innerHTML='';
  if((mode||document.getElementById('v-sched-form').dataset.mode)==='lights'){
    w.innerHTML=`<button class="pill" data-t="LIGHT" data-v="1">Encender</button>
                 <button class="pill" data-t="LIGHT" data-v="0">Apagar</button>`;
  }else{
    w.innerHTML=`<button class="pill" data-t="SHUTTER" data-d="UP">Abrir</button>
                 <button class="pill" data-t="SHUTTER" data-d="DOWN">Cerrar</button>
                 <button class="pill" data-t="SHUTTER" data-d="PERCENT">Porcentaje</button>`;
  }
  w.querySelectorAll('.pill').forEach(b=>b.onclick=()=>{w.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));b.classList.add('active');togglePct(b.dataset.d==='PERCENT')});
  if(existing){
    const sel=[...w.querySelectorAll('.pill')].find(b=> (existing.type==='LIGHT' && b.dataset.t==='LIGHT' && +b.dataset.v===existing.value) ||
      (existing.type==='SHUTTER' && b.dataset.t==='SHUTTER' && b.dataset.d===existing.dir) );
    if(sel) sel.click();
    if(existing.type==='SHUTTER' && existing.dir==='PERCENT'){document.getElementById('sfPercent').value=existing.percent||50}
  }else{ w.querySelector('.pill').click(); }
}
function togglePct(show){document.getElementById('sfPctWrap').classList.toggle('hidden', !show)}
function buildDays(pre=[]){const w=document.getElementById('sfDays');w.innerHTML='';['L','M','X','J','V','S','D'].forEach((d,i)=>{const b=document.createElement('button');b.className='pill';b.textContent=d;b.dataset.i=i;if(pre.includes(i)) b.classList.add('active');b.onclick=()=>b.classList.toggle('active');w.appendChild(b)})}
document.getElementById('sfTrigType').addEventListener('change',showTrig);
function showTrig(){const t=document.getElementById('sfTrigType').value;document.getElementById('sfTrigTime').classList.toggle('hidden',t!=='time');document.getElementById('sfTrigSolar').classList.toggle('hidden',t!=='solar')}
function pad2(n){return (n<10?'0':'')+n}

async function saveSchedule(){
  const mode=document.getElementById('v-sched-form').dataset.mode;
  const name=document.getElementById('sfName').value.trim(); if(!name) return toast('Pon un nombre');
  const targetType=document.getElementById('sfTargetType').value;
  let ids=[]; if(targetType!=='ALL'){ids=[...document.querySelectorAll('#sfTargetWrap .pill.active')].map(b=>b.dataset.id); if(!ids.length) return toast('Selecciona destino')}
  const aSel=document.querySelector('#sfActionWrap .pill.active'); if(!aSel) return toast('Elige acci√≥n');
  let action=null;
  if(aSel.dataset.t==='LIGHT'){action={type:'LIGHT',value:+aSel.dataset.v}}
  else{ action={type:'SHUTTER',dir:aSel.dataset.d}; if(aSel.dataset.d==='PERCENT'){const pct=+document.getElementById('sfPercent').value; if(!(pct>=0&&pct<=100)) return toast('Porcentaje 0-100'); action.percent=pct} }
  const trigType=document.getElementById('sfTrigType').value;
  let trigger=null;
  if(trigType==='time'){ trigger={type:'time',at:document.getElementById('sfTime').value||'08:00'} }
  else{ trigger={type:'solar',event:document.getElementById('sfSolarEvent').value,sign:document.getElementById('sfSolarSign').value,h:+document.getElementById('sfSolarH').value,m:+document.getElementById('sfSolarM').value} }
  const days=[...document.querySelectorAll('#sfDays .pill.active')].map(b=>+b.dataset.i); if(!days.length) return toast('Selecciona d√≠as');

  const sched={ id: document.getElementById('v-sched-form').dataset.edit || String(Date.now()),
    name, target:{type:targetType,ids}, action, trigger, days, enabled:true };

  if(mode==='lights'){
    const i=schedulesLights.findIndex(x=>x.id===sched.id);
    if(i>=0) schedulesLights[i]=sched; else schedulesLights.push(sched);
  }else{
    const i=schedulesShutters.findIndex(x=>x.id===sched.id);
    if(i>=0) schedulesShutters[i]=sched; else schedulesShutters.push(sched);
  }
  
  // Guardar en la nube
  log(`Schedule saved [${mode}] ‚Üí ${sched.name}`);
  const ok = await saveSchedulesToCloud();
  if(ok) {
    toast('Programaci√≥n guardada en la nube');
    go(mode==='lights'?'lights':'shutters');
  } else {
    toast('Error al guardar. Reintenta.');
    // Opcional: revertir el cambio en el array local si falla
  }
}

function cancelSchedule(){go(document.getElementById('v-sched-form').dataset.mode==='lights'?'lights':'shutters')}

async function schedToggle(mode,id){
  const arr=mode==='lights'?schedulesLights:schedulesShutters;
  const s=arr.find(x=>x.id===id);
  if(!s) return;
  s.enabled=!s.enabled; // Cambia el estado localmente
  log(`Schedule toggle [${mode}] ${id} ‚Üí ${s.enabled?'ON':'OFF'}`);
  
  // Intenta guardar en la nube
  const ok = await saveSchedulesToCloud();
  if(ok) {
    toast('Estado guardado en la nube');
  } else {
    s.enabled=!s.enabled; // Revertir el cambio si falla
    toast('Error al guardar estado');
    // Actualizar la UI para revertir el switch
    const checkbox = document.querySelector(`[onchange="schedToggle('${mode}','${s.id}')"]`);
    if (checkbox) checkbox.checked = s.enabled;
  }
}

async function schedDel(mode,id){
  if (!confirm('¬øSeguro que quieres borrar esta programaci√≥n?')) return;
  
  let arr=mode==='lights'?schedulesLights:schedulesShutters;
  const originalArr = [...arr]; // Copia de seguridad
  arr=arr.filter(x=>x.id!==id);
  
  if(mode==='lights'){ schedulesLights=arr; }else{ schedulesShutters=arr; }
  log(`Schedule deleted [${mode}] ${id}. Guardando en nube...`);
  
  const ok = await saveSchedulesToCloud();
  if (ok) {
    toast('Programaci√≥n borrada');
    renderSchedLists(); // Actualiza la UI
  } else {
    toast('Error al borrar');
    // Revertir
    if(mode==='lights'){ schedulesLights=originalArr; }else{ schedulesShutters=originalArr; }
  }
}

// =================================================================
//          FIN DE LA MODIFICACI√ìN (MOTOR LOCAL ELIMINADO)
// =================================================================


/*** === Exportar/Copiar logs === */
async function exportLogs(){
  try{
    const text = (logs && logs.length) ? logs.join('\n') : '(sin registros)';
    try{
      await navigator.clipboard.writeText(text);
      toast('Logs copiados al portapeles');
      log('Logs copiados al portapeles');
    }catch(e){
      toast('No se pudo copiar, se descargan');
    }
    const blob=new Blob([text],{type:'text/plain'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='domotica_logs.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log('Logs exportados (descarga)');
  }catch(err){
    toast('Error al exportar logs');
    log('Error exportando logs: '+(err&&err.message?err.message:err));
  }
}

/*** === Click sonoro + feedback t√°ctil === */
let audioCtx=null;
function playClick(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type='square'; o.frequency.value=1000;
    g.gain.setValueAtTime(0.08, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.04);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+0.04);
  }catch(e){}
}
function pushFxOn(e){
  const t=e.target.closest('.btn,.arc,.pill'); if(!t) return;
  t.classList.add('pressed'); playClick();
}
function pushFxOff(e){
  const t=e.target.closest('.btn,.arc,.pill'); if(!t) return;
  t.classList.remove('pressed');
}
document.addEventListener('pointerdown',pushFxOn);
document.addEventListener('pointerup',pushFxOff);
document.addEventListener('pointercancel',pushFxOff);
document.addEventListener('pointerleave',pushFxOff);

/*** === Inicio === ***/
// Los perfiles (IP) y calibraciones (tiempos) se siguen cargando localmente
// Las programaciones (schedules) se cargar√°n desde la nube al entrar en la secci√≥n
document.addEventListener('DOMContentLoaded',()=>{
  renderBadge();
  go('home');
  // Cargar calibraciones locales al inicio
  shutterCalibrations=JSON.parse(localStorage.getItem('domo_shutterCalibrations')||'{}');
  log('App iniciada. Calibraciones locales cargadas.');
});
</script>
</body>
</html>
